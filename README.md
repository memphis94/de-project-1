# Витрина для RFM-классификации пользователей приложения (Food Delivery)
### Требования к целевой витрине:
1.	Расположение – схема analysis в исходной базе данных.
2.	Структура витрины:
    *	user_id
    *	recency (число от 1 до 5)
    *	frequency (число от 1 до 5)
    *	monetary_value (число от 1 до 5)
3.	Глубина витрины – данные с начала 2021 года.
4.	Название витрины - dm_rfm_segments
5.	Частота обновления – обновления не нужны.
6.	Успешно выполненный заказ – это заказ со статусом closed.

### Схема исходных данных:

![image](https://user-images.githubusercontent.com/69753101/165421763-116a3171-b2d2-4c80-baf4-2ad57175ea3d.png)

### Ограничения исходных данных:

![image](https://user-images.githubusercontent.com/69753101/165421963-c43a7477-90ed-4aae-a44b-320af29ebabb.png)

### Ход работы над витриной

#### Kачество данных схемы production.



##### Общее:

Во всех таблицах схемы production стоит ограничение NOT NULL для каждого значения, то есть пустые значения не могут попасть в таблицы.

##### Таблица users
Количество уникальных id, name и login совпадает (1000), что говорит об отсутствии дублей в таблице.
Замечена смысловая ошибка в названии столбцов - поле name содержит данные логинах, а login содержит ФИО.
Нужно сообщить заказчику/администратору БД о смысловом несоответствии и предложить переименование столбцов.


##### Таблица order_statuses

Таблица состоит из 5 уникальных записей, id статуса (id) и наименование статуса(key).
Статус closed для отбора выполненных заказов присутствует


##### Таблица orderstatuslog

Каждой строчке соответствует уникальные id. Количество уникальных id заказов и id статусов совпадает с уникальными количествами 
из основных таблиц, orders и order_statuses.
Данные дате и времени изменения статуса (dttm) начинаются с 12 февраля 2022 и заканчиваются 14 марта 2022. 


##### Таблица orders

Данные по дате и времени заказа (order_ts) начинаются с 12 февраля 2022 и заканчиваются 14 марта 2022. 
Все order_id уникальны. Есть дубли в столбце order_ts, но при проверке, только эти значения и совпадают у заказов, 
у которых одинаковый order_ts, остальные столбцы имеют различные значения.
Количество уникальных user_id совпадает с количеством уникальных id из таблицы users.
Все значения bonus_payment равны нулю. Учитывая, что в таблице не может быть пропущенных значений 
и по умолчанию значение 0 - то это может говорить, что значения отсутствуют.
Нулевых значений стоимости(cost), суммы оплаты(payment) и начисляемых бонусах(bonus_granted) не обнаружено.
Нужно сообщить заказчику о неполных данных (не с начала 2021 года).  А также уведомить администратора БД о нулевых значениях bonus_payment.


##### Таблица orderitems

Таблица содержит 47369 строк и 47369 уникальных id заказов.
Количество уникальных product_id соответствует количеству уникальных id из таблицы products.
Количество уникальных order_id соответствует количеству уникальных order_id из таблицы products.
Нулевыех значений в столбцах price и quantity не обнаружено.
Все значения столбца discount равны нулю, учитывая что 0 - это значения по умолчанию - то это может говорить, что значения отсутствуют.
Нужно уведомить ответственного за БД о нулевых значениях discount.


##### Таблица products

Таблица состоит из 21 уникальной записи, уникальные id и названия продукта(name) также содержат по 21 строчке.
Цена на некоторые продукты совпадает.


#### Инструменты для обеспечения качества данных в таблицах в схеме production.

Во всех таблицах схемы production стоит ограничение NOT NULL для каждого значения, то есть пустые значения не могут попасть в таблицы.

##### users
Первичный ключ id

##### orderstatuses
Первичный ключ id

##### orderstatuslog
Первичный ключ id
Ограничение на уникальность комбинации order_id,status_id.
Вторичный ключ order_id ссылающийся на production.orders(order_id)
Вторичный ключ status_id ссылающийся на production.orderstatuses(id)

##### orders
Первичный ключ order_id
Проверка каждой строчки  столбца cost как суммы значений payment и bonus_payment

##### order_items
Первичный ключ id
Проверка, что каждая значение каждой строчки столбца discount является числом, равным или с большим значением, чем ноль. А также что не может быть выше значения price.
Вторичный ключ order_id ссылающийся на production.orders(order_id)
Вторичный ключ product_id ссылающийся на production.products(id)
Ограничение на уникальность комбинации order_id,product_id.
Проверка, что каждое значение каждой строчки столбца price является числом, равным или с большим значением, чем ноль.
Проверка, что каждое значение каждой строчки столбца quantity с большим значением, чем ноль.

##### products
Первичный ключ id
Проверка, что каждое значение каждой строчки столбца price является числом, равным или с большим значением, чем ноль.

#### Подготовка витрины данных.

##### Создание представлений
CREATE VIEW products AS
SELECT * FROM production.products;

CREATE VIEW orderitems AS
SELECT * FROM production.orderitems;

CREATE VIEW orders AS
SELECT * FROM production.orders;

CREATE VIEW orderstatuses AS
SELECT * FROM production.orderstatuses;

CREATE VIEW users AS
SELECT * FROM production.users;

CREATE VIEW orderstatuslog AS
SELECT * FROM production.orderstatuslog;

##### Создание витрины
CREATE TABLE dm_rfm_segments (
	user_id int4 NOT NULL,
	recency int4 NOT NULL,
	frequency int4 NOT NULL,
	monetary_value int4 NOT NULL)
